<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="index.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="assets/stylesheets/dota2minimapheroes.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.0.4/fuse.min.js"></script>
    <style>
            #sorters, #notused{ list-style-type: none; margin: 0; float: inherit; margin-right: 10px; background: #eee; padding: 5px; width: 143px;}
            #sorters li, #notused li{ margin: 5px; padding: 5px; font-size: 1.2em; width: 120px; float: inherit;}
            /* li { list-style-type: none; } */
    </style>
    <script>
        var regedSortFuncs = {}
        var allProps = {};
        var skipProps = ["In our pool",];
        var def_HBGcolour = "white"
        var high_HBGcolour = "yellow"
        var chartOptions = {chartArea:{width:'30%'},
                            legend: {position: 'none'}};
        var fuse;
        var fuseOptions = {
            threshold: 0.1,
            location: 0,
            distance: 100,
            maxPatternLength: 32,
            minMatchCharLength: 1,
            keys: ["id", "nicks"]
        };
        function sortInObj(a, b, attrib){
            if(a[attrib] > b[attrib]){
                return -1
            }
            if(a[attrib] < b[attrib]){
                return 1
            }
            return 0
        }
        function propComparator(prop) {
            return function(a, b) {
                return a[prop] - b[prop];
            }
        }
        function sortHeroes(){
            var sortby = $("#sorters").children('.sorter').get();
            var hero_list = $("#hero_list").children('li').get()

            function multiSort(a,b,sortby){
                var prop_a = $("#"+a.id).data("data");
                var prop_b = $("#"+b.id).data("data");
                
                for (const sorter of sortby){
                    var propName = sorter.getAttribute("propname")
                    if(prop_a[propName] == prop_b[propName]){
                        continue;
                    }
                    return prop_b[propName] - prop_a[propName]
                }
                //Fully equal under sort
                return 0
            }
            hero_list.sort(function(a,b){return multiSort(a,b,sortby)})
            $.each(hero_list, function(idx, itm) { $("#hero_list").append(itm); });
        }

        $( function() {
            //Load hero grid and setup conditions
            $.getJSON("dataFull.json", buildList);
            //Load searchable list and init fuse
            $.getJSON("heroSearch.json", initFuse);
            //Setup sortable lists
            $( "#notused" ).sortable({
                connectWith: ".connectedSortable"
            });
            $( "#sorters" ).sortable({
                connectWith: ".connectedSortable",
                update: function(event, ui) {
                  sortHeroes()
                },
            });
            $("#hero_list").sortable({
                connectWith: ".connectedHeroes",
                placeholder: ".hero-highlight"
            })
            $(".pickban").sortable(
                {
                connectWith: ".connectedHeroes",
                // placeholder: "hero-highlight",
                update: function(event, ui){updatePBChart(event);}
            })
            //Setup google charts and draw placeholders.
            google.charts.load('current', {packages: ['corechart', 'bar']});
            google.charts.setOnLoadCallback(drawBasic);
            //Search box on update
            $("#hsearch").on("change", function(o, a){updateHeroHigh();});
            $("#hsearch").val("");
        } );
        function updateHeroHigh(){
            $(".hero_list_highlight").removeClass("hero_list_highlight")
            var search = $("#hsearch").val();
            var result = fuse.search(search);
            for (const r in result){
                var portrait = $(result[r]['id']).children(".d2mh")
                portrait.addClass("hero_list_highlight");
            }
        }
        function drawBasic(){
            //Load in some zero charts
            var data = new google.visualization.DataTable();
            data.addColumn('string','Category');
            data.addColumn('number','Rating');
            for (const prop in allProps){
                data.addRow([prop, allProps[prop]]);
            }
            $(".graphs").each(function(i,elem){
                var chart = new google.visualization.BarChart(elem);
                chart.draw(data, chartOptions);
            });
        }
        function updatePBChart(event){
            var $target = $(event.target);
            var heroes = $target.children();
            //Jquery javascript method for creating a clone
            //console.log(heroes);
            var clone = $.extend({}, allProps);
            heroes.each(function(i, elem){
                var hData = $(elem).data("data")
                for (const prop in allProps){
                    clone[prop] += hData[prop];
                }
            })
            var data = new google.visualization.DataTable();
            data.addColumn('string','Category');
            data.addColumn('number','Rating');
            for (const prop in clone){
                data.addRow([prop, clone[prop]]);
            }
            $target.data("graph", data)
            var chart = new google.visualization.BarChart($target.siblings(".graphs")[0]);
            chart.draw(data, chartOptions);
        }
        function buildList(json){
            for (const hero in json){
                var cName = hero.toLowerCase();
                //console.log(cName)
                var imgName = "d2mh " + cName;
                var html = "<li><i class = '" + imgName + "'></i></li>";
                $(html).appendTo("#hero_list").attr("id", cName);
                //Add the other info from the json
                //console.log(json[hero])
                $("#" + cName).data("data",json[hero]);
                //test = $("#" + cName).data("data")['Team Fight']
                // console.log(test)
            }
            //Make a list of properties to sort by assuming the first hero has all the options
            for (const hero in json){
                for (const property in json[hero]){
                    regedSortFuncs[property] = function(a,b){return sortInObj(a,b,property)};
                    var id = "sort" + property.replace(/\s+/g, '');
                    var html = "<li class='ui-state-default sorter'>"+ property +"</li>";
                    $(html).appendTo("#notused").attr("id", id).attr("propName", property);
                    //Also add to the picks and bans for graphing
                    if ($.inArray(property, skipProps) == 0){
                        continue;
                    }
                    allProps[property] = 0;
                }
                // var footers = $(".pick, .ban").children();
                // $.each(footers, function(i, val){$.data(val, "graph", allProps);});
                break;
            }
            toggleHListHero("#tidehunter");
            toggleHListHero("#timbersaw");
            toggleHListHero("#tidehunter");
        }
        function initFuse(json){
            fuse = new Fuse(json, fuseOptions);
        }
        function toggleHListHero(hero){
            var portrait = $(hero).children(".d2mh")
            portrait.toggleClass("hero_list_highlight");
        }
    </script>
</head>
<body>
    <div class="sidebar">
        Sort by:
        <ul id="sorters" class="connectedSortable"></ul>
        Not applied:
        <ul id="notused" class="connectedSortable"></ul>
    </div>
    <div class="content">
        <input id="hsearch" type="text" style="width:100%">
        <div id="htest">
            <ul id="hero_list" class="connectedHeroes"></ul>
            <!-- <span class="clear"></span> -->
        </div>
        <div style="clear: both;"></div>
        <div id="pb_footer">
            <div class="content-footer-left">
                <div class="pick">
                    <ul id="lpick" class="connectedHeroes pickban"></ul>
                    <div class='connectedHeroes graphs' id="lpickgraph"></div>
                </div>
                <div class="ban">
                    <ul id="lban" class="connectedHeroes pickban"></ul>
                    <div class='connectedHeroes graphs' id="lbangraph"></div>
                </div>
            </div>
            <div class="content-footer-right">
                <div class="pick">
                    <ul id="rpick" class="connectedHeroes pickban"></ul>
                    <div class='graphs' id="rpickgraph"></div>
                </div>
                <div class="ban">
                    <ul id="rban" class="connectedHeroes pickban"></ul>
                    <div class='graphs' id="rbangraph"></div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>